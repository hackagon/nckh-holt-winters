---
title: "Dac diem cac thuoc su dung theo biet duoc va generic"
output: 
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, results='hide',message=FALSE}
tonghop <- read.csv("./csv/tonghop_processed.csv", stringsAsFactors = FALSE)
tonghop$dem <- rep(1, nrow(tonghop))
tonghop$xuattrongky_sl[which(is.na(tonghop$xuattrongky_sl))] <- 0
tonghop$xuattrongky_thanhtien[which(is.na(tonghop$xuattrongky_thanhtien))] <- 0

# hoatchat_dvt
tonghop$hoatchat_dvt <- paste(tonghop$hoatchat, tonghop$dvt, sep = "_")

# biet duoc
bietduoc_index <- which(tonghop$nhomBD == 1) 
bietduoc_df <- tonghop[bietduoc_index, ]
bietduoc_aggregate_df <- aggregate(xuattrongky_sl ~ hoatchat_dvt, bietduoc_df,FUN = sum)
bietduoc_aggregate_df$xuattrongky_thanhtien <- aggregate(xuattrongky_thanhtien ~ hoatchat_dvt, bietduoc_df,FUN = sum)$xuattrongky_thanhtien
bietduoc_sl_thuoc <- nrow(bietduoc_aggregate_df)
bietduoc_coso_thuoc_sd <- sum(bietduoc_aggregate_df$xuattrongky_sl)
bietduoc_cp <- sum(bietduoc_aggregate_df$xuattrongky_thanhtien)

# generic
generic_index <- which(tonghop$nhomBD == 2) 
generic_df <- tonghop[generic_index, ]
generic_aggregate_df <- aggregate(xuattrongky_sl ~ hoatchat_dvt, generic_df,FUN = sum)
generic_aggregate_df$xuattrongky_thanhtien <- aggregate(xuattrongky_thanhtien ~ hoatchat_dvt, generic_df,FUN = sum)$xuattrongky_thanhtien
generic_sl_thuoc <- nrow(generic_aggregate_df)
generic_coso_thuoc_sd <- sum(generic_aggregate_df$xuattrongky_sl)
generic_cp <- sum(generic_aggregate_df$xuattrongky_thanhtien)

# tong so luong thuoc theo bietduoc/generic
tong_sl_thuoc <- bietduoc_sl_thuoc + generic_sl_thuoc
tong_coso_thuoc_sd <- bietduoc_coso_thuoc_sd + generic_coso_thuoc_sd
tong_cp <- bietduoc_cp + generic_cp

bietduoc_phantram <- bietduoc_sl_thuoc / tong_sl_thuoc
generic_phantram <- generic_sl_thuoc / tong_sl_thuoc
bietduoc_coso_sd_phantram <- bietduoc_coso_thuoc_sd / tong_coso_thuoc_sd
generic_coso_sd_phantram <- generic_coso_thuoc_sd / tong_coso_thuoc_sd
bietduoc_cp_phantram <- bietduoc_cp / tong_cp
generic_cp_phantram <- generic_cp / tong_cp

# generate bietduoc_generic_df
bietduoc_generic_df <- data.frame(matrix(ncol = 0, nrow = 2))
bietduoc_generic_df$phan_loai <- c("Biet duoc", "Generic")
bietduoc_generic_df$sl_thuoc <- c(bietduoc_sl_thuoc, generic_sl_thuoc)
bietduoc_generic_df$thuoc_phantram <- c(bietduoc_phantram, generic_phantram)
bietduoc_generic_df$coso_thuoc_sd <- c(bietduoc_coso_thuoc_sd, generic_coso_thuoc_sd)
bietduoc_generic_df$coso_thuoc_sd_phantram <- c(bietduoc_coso_sd_phantram, generic_coso_sd_phantram)
bietduoc_generic_df$cp_thuoc <- c(bietduoc_cp, generic_cp)
bietduoc_generic_df$cp_thuoc_phantram <- c(bietduoc_cp_phantram, generic_cp_phantram)
```

**3.1.1 Dac diem cac thuoc su dung theo phan loai thuoc biet duoc va generic tai benh vien TMHH giai doan 2014 - 2018**

* Mo ta dac diem cua cac thuoc su dung theo phan loai thuoc biet duoc va generic trong 5 nam tu 2014 - 2018

```{r bietduoc_generic}
knitr::kable(bietduoc_generic_df, format="html", 
             col.names = c("Phan loai", "SL thuoc", "% thuoc", "Co so", "% co so", "Chi phi", "% chi phi"))
```

```{r echo=FALSE, results='hide',message=FALSE}
bietduoc_nam <- aggregate(x=list(
  coso = as.numeric(bietduoc_df$xuattrongky_sl),
  chiphi = as.numeric(bietduoc_df$xuattrongky_thanhtien)
  ), by=list(nam=bietduoc_df$nam), FUN=sum)

bietduoc_nam$soluong <- c(
  length(unique(bietduoc_df[which(bietduoc_df$nam == 2014), ]$hoatchat)),
  length(unique(bietduoc_df[which(bietduoc_df$nam == 2015), ]$hoatchat)),
  length(unique(bietduoc_df[which(bietduoc_df$nam == 2016), ]$hoatchat)),
  length(unique(bietduoc_df[which(bietduoc_df$nam == 2017), ]$hoatchat)),
  length(unique(bietduoc_df[which(bietduoc_df$nam == 2018), ]$hoatchat))
)
```

* Mo ta tang giam biet duoc qua cac nam

```{r tyle_bietduoc}
knitr::kable(bietduoc_nam, format="html", 
             col.names = c("nam", "co so", "chi phi", "so luong"))
```

```{r echo=FALSE, results='hide',message=FALSE}
generic_nam <- aggregate(x=list(
  coso = as.numeric(generic_df$xuattrongky_sl),
  chiphi = as.numeric(generic_df$xuattrongky_thanhtien)
  ), by=list(nam=generic_df$nam), FUN=sum)

generic_nam$soluong <- c(
  length(unique(generic_df[which(generic_df$nam == 2014), ]$hoatchat)),
  length(unique(generic_df[which(generic_df$nam == 2015), ]$hoatchat)),
  length(unique(generic_df[which(generic_df$nam == 2016), ]$hoatchat)),
  length(unique(generic_df[which(generic_df$nam == 2017), ]$hoatchat)),
  length(unique(generic_df[which(generic_df$nam == 2018), ]$hoatchat))
)
```

* Mo ta tang giam generic qua cac nam

```{r tyle_generic}
knitr::kable(generic_nam, format="html", 
             col.names = c("nam", "co so", "chi phi", "so luong"))
```
